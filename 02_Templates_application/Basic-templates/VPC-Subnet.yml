AWSTemplateFormatVersion: 2010-09-09
Description: |
  VPC and Subnet
# ------------------------------------------------------------#
# Input Parameters
# ------------------------------------------------------------# 
Parameters:
  VpcCidrBlock:
    Description: input vpc cidrblock
    Type: String
    Default: 10.0.0.0/16

  PublicSubnetCidrBlock:
    Description: input subnet cidrblock
    Type: String
    Default: 10.0.0.0/24

  PrivateSubnetCidrBlock:
    Description: input subnet cidrblock
    Type: String
    Default: 10.0.10.0/24

  PublicSubnetAvailabilityZone:
    Description: input public subnet AvailabilityZone
    Type: AWS::EC2::AvailabilityZone::Name
    Default: ap-northeast-1a

  PrivateSubnetAvailabilityZone:
    Description: input private subnet AvailabilityZone
    Type: AWS::EC2::AvailabilityZone::Name
    Default: ap-northeast-1a
  
# ------------------------------------------------------------#
# MetaData
# ------------------------------------------------------------# 
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      -
        Label:
          default: "VPC and Subnet Configuration"
        Parameters:
          - VpcCidrBlock
          - PublicSubnetCidrBlock
          - PrivateSubnetCidrBlock
          - PublicSubnetAvailabilityZone
          - PrivateSubnetAvailabilityZone

Resources:
# ------------------------------------------------------------#
#  VPC
# ------------------------------------------------------------#
  VPCID:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidrBlock
      EnableDnsHostnames: false
      EnableDnsSupport: true
      InstanceTenancy: default

# ------------------------------------------------------------#
#  Internet Gateway
# ------------------------------------------------------------#
  INTERNETGATEWAYID:
    Type: AWS::EC2::InternetGateway

  INTERNETGATEWAYATTATCHMENTID:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref INTERNETGATEWAYID
      VpcId: !Ref VPCID

# ------------------------------------------------------------#
#  Route Table
# ------------------------------------------------------------#
  ROUTETABLEID:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPCID
      
  # インターネットゲートウェイをルートテーブルに登録
  INTERNETGATEWAYROUTEID:
    Type: AWS::EC2::Route
    Properties:
      GatewayId: !Ref INTERNETGATEWAYID
      RouteTableId: !Ref ROUTETABLEID
      DestinationCidrBlock: 0.0.0.0/0

# ------------------------------------------------------------#
#  Subnet
# ------------------------------------------------------------#
# Public
  PUBLICSUBNETID:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Ref PublicSubnetAvailabilityZone
      CidrBlock: !Ref PublicSubnetCidrBlock
      VpcId: !Ref VPCID

  PUBLICSUBNETROUTETABLEASSOCIATIONID:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref ROUTETABLEID
      SubnetId: !Ref PUBLICSUBNETID

# Private
  PRIVATESUBNETID:
    Type: AWS::EC2::Subnet
    Properties:
      AvailabilityZone: !Ref PrivateSubnetAvailabilityZone
      CidrBlock: !Ref PrivateSubnetCidrBlock
      VpcId: !Ref VPCID

  PRIVATESUBNETROUTETABLEASSOCIATIONID:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref ROUTETABLEID
      SubnetId: !Ref PRIVATESUBNETID

# ------------------------------------------------------------#
#  Outputs
# ------------------------------------------------------------#
Outputs:
  OUTPUTVPCID:
    Description: vpc id
    Value: !Ref VPCID
    Export: 
      Name: !Sub ${AWS::StackName}-OutputVpcId

  OUTPUTPUBLICSUBNETID:
    Description: public subnet id
    Value: !Ref PUBLICSUBNETID
    Export: 
      Name: !Sub ${AWS::StackName}-OutputPublicSubnetId

  OUTPUTPRIVATESUBNETID:
    Description: private subnet id
    Value: !Ref PRIVATESUBNETID
    Export: 
      Name: !Sub ${AWS::StackName}-OutputPrivateSubnetId
